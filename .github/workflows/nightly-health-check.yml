name: Nightly Production Health Check

on:
  schedule:
    # Run every night at 2 AM ET (7 AM UTC)
    - cron: '0 7 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check production site
        id: health
        run: |
          echo "Checking needhamnavigator.com..."

          # --- CHECK 1: Homepage loads ---
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "https://www.needhamnavigator.com/needham" || echo "000")
          echo "Homepage HTTP code: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "homepage_status=down" >> $GITHUB_OUTPUT
            echo "homepage_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          else
            echo "homepage_status=up" >> $GITHUB_OUTPUT
            echo "homepage_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          fi

          # --- CHECK 2: Chat API functional test (with retries) ---
          API_UP="false"
          API_STATUS="down"
          API_HTTP="000"
          API_BODY=""
          API_DETAIL=""

          for attempt in 1 2 3; do
            echo "Chat API attempt $attempt of 3..."

            # Single curl call captures both body and HTTP code
            RAW_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" --max-time 60 -X POST "https://www.needhamnavigator.com/api/chat" \
              -H "Content-Type: application/json" \
              -d '{"messages":[{"role":"user","content":"What are the hours for Needham Town Hall?"}],"townId":"needham"}' 2>/dev/null || echo "HTTP_CODE:000")

            API_HTTP=$(echo "$RAW_RESPONSE" | grep -o 'HTTP_CODE:[0-9]*' | tail -1 | cut -d: -f2)
            API_BODY=$(echo "$RAW_RESPONSE" | sed '/HTTP_CODE:[0-9]*/d')
            API_HTTP=${API_HTTP:-000}

            echo "  HTTP code: $API_HTTP"
            echo "  Response length: ${#API_BODY} chars"

            # SUCCESS: 200 or 201 with a non-trivial response body
            if [ "$API_HTTP" = "200" ] || [ "$API_HTTP" = "201" ]; then
              if [ ${#API_BODY} -gt 50 ]; then
                if [ "$attempt" -eq 1 ]; then
                  API_STATUS="up"
                else
                  API_STATUS="degraded"
                fi
                API_UP="true"
                API_DETAIL="Functional response received (attempt $attempt)"
                echo "  Chat API OK on attempt $attempt"
                break
              else
                echo "  Response too short (${#API_BODY} chars), retrying..."
              fi
            fi

            # HARD FAIL (no retry): HTTP 500
            if [ "$API_HTTP" = "500" ]; then
              API_DETAIL="Server error (HTTP 500) ‚Äî response: ${API_BODY:0:200}"
              echo "  Hard failure (500), not retrying"
              break
            fi

            # RETRY-WORTHY: 000 (timeout), 400, 429 (rate limit), 502, 503
            echo "  Attempt $attempt failed (HTTP $API_HTTP), retrying in 60s..."
            [ "$attempt" -lt 3 ] && sleep 60
          done

          # Final status
          if [ "$API_UP" = "false" ]; then
            API_DETAIL=${API_DETAIL:-"All 3 attempts failed (last HTTP $API_HTTP) ‚Äî response: ${API_BODY:0:200}"}
          fi

          echo "api_status=$API_STATUS" >> $GITHUB_OUTPUT
          echo "api_code=$API_HTTP" >> $GITHUB_OUTPUT
          echo "api_detail=$API_DETAIL" >> $GITHUB_OUTPUT
          echo "Chat API final status: $API_STATUS (HTTP $API_HTTP)"

          # --- CHECK 3: Permits page loads ---
          PERMITS_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "https://www.needhamnavigator.com/needham/permits" || echo "000")
          echo "Permits page HTTP code: $PERMITS_CODE"

          if [ "$PERMITS_CODE" != "200" ]; then
            echo "permits_status=down" >> $GITHUB_OUTPUT
            echo "permits_code=$PERMITS_CODE" >> $GITHUB_OUTPUT
          else
            echo "permits_status=up" >> $GITHUB_OUTPUT
            echo "permits_code=$PERMITS_CODE" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if site is down
        if: steps.health.outputs.homepage_status == 'down' || steps.health.outputs.api_status == 'down' || steps.health.outputs.permits_status == 'down'
        uses: actions/github-script@v7
        with:
          script: |
            const homepageStatus = '${{ steps.health.outputs.homepage_status }}';
            const homepageCode = '${{ steps.health.outputs.homepage_code }}';
            const apiStatus = '${{ steps.health.outputs.api_status }}';
            const apiCode = '${{ steps.health.outputs.api_code }}';
            const apiDetail = '${{ steps.health.outputs.api_detail }}';
            const permitsStatus = '${{ steps.health.outputs.permits_status }}';
            const permitsCode = '${{ steps.health.outputs.permits_code }}';
            const today = new Date().toISOString().split('T')[0];

            const statusIcon = (s) => s === 'up' ? '‚úÖ Up' : s === 'degraded' ? 'üü° Degraded' : '‚ùå Down';

            let body = `## Production Health Check Failed ‚Äî ${today}\n\n`;
            body += `| Endpoint | Status | HTTP Code | Detail |\n|---|---|---|---|\n`;
            body += `| Homepage | ${statusIcon(homepageStatus)} | ${homepageCode} | ‚Äî |\n`;
            body += `| Chat API | ${statusIcon(apiStatus)} | ${apiCode} | ${apiDetail} |\n`;
            body += `| Permits | ${statusIcon(permitsStatus)} | ${permitsCode} | ‚Äî |\n\n`;
            body += `**What to do:**\n`;
            body += `1. Check Vercel deployment logs: https://vercel.com/charlie-temkins-projects/needham-navigator\n`;
            body += `2. Open a Claude Code session and run the agent preflight checklist\n`;
            body += `3. If the last deploy broke things, use Vercel's "Instant Rollback" button\n`;
            body += `4. The chat API test sends a real question ("What are the hours for Needham Town Hall?") ‚Äî if it fails, the AI pipeline is broken, not just the server\n`;
            body += `5. Chat API retried 3 times with 60s delays before marking as down ‚Äî this is not a transient blip\n`;

            // Check if there's already an open health-check issue to avoid duplicates
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'prod-down',
              state: 'open'
            });

            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üî¥ Production is down ‚Äî ${today}`,
                body: body,
                labels: ['prod-down']
              });
            } else {
              // Add a comment to the existing issue instead
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `**Still down as of ${today}:**\n\nHomepage: ${homepageCode} | Chat API: ${apiCode} (${apiDetail}) | Permits: ${permitsCode}`
              });
            }
